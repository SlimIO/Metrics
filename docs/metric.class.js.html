<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>metric.class.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Entity.html">Entity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#set">set</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Entity.html#toJSON">toJSON</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Metric.html">Metric</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Metric.html#sendMessage">sendMessage</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MetricIdentityCard.html">MetricIdentityCard</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#entity">entity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#identityCard">identityCard</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">metric.class.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Require Internal Dependencies
const Entity = require("./entity.class.js");
const MetricIdentityCard = require("./metricIdentityCard.class.js");

/**
 * @class Metric
 * @property {Addon} addon Addon
 * @property {Entity} entity Entity
 * @property {Boolean=} [eventLoaded=false] Event addon is loaded ?
 */
class Metric {
    /**
     * @constructor
     * @param {Addon} addon Addon
     *
     * @throws {TypeError}
     */
    constructor(addon) {
        if (addon.constructor.name !== "Addon") {
            throw new TypeError("addon param must be an Addon object");
        }

        this.eventLoaded = false;
        this.addon = addon;

        /** @type {Array&lt;Entity>} */
        this.entities = [];

        /** @type {Map&lt;String, MetricIdentityCard>} */
        this.mic = new Map();

        /** @type {Map&lt;Entity.id, Entity.parent|MetricIdentityCard.name>} */
        this.linker = new Map();

        this.addon.on("addonLoaded", (addonName) => {
            if (addonName === "events") {
                this.eventLoaded = true;
                if (this.entities.length > 0) {
                    this.declare();
                }
            }
        });
    }

    /**
     * @method sendMessage
     * @memberof Metric#
     * @param {String} event event
     * @param {Object} data data
     * @return {Promise&lt;number>}
     */
    sendMessage(event, data) {
        return new Promise((resolve) => {
            this.addon.sendMessage(event, { args: [data] }).subscribe(resolve);
        });
    }

    /**
     * @private
     * @async
     * @method declare
     * @memberof Metric#
     * @param {Number} parentIndex parentIndex
     *
     * @returns {void}
     */
    async declare(parentIndex = 1) {
        if (!this.linker.has(parentIndex)) {
            return;
        }
        const promises = [];
        const elems = this.linker.get(parentIndex);
        for (const elem of elems) {
            if (typeof elem === "number") {
                const entity = this.entities[elem];
                promises.push(this.declareEntity(entity));
            }
            else {
                const mic = this.mic.get(elem);
                this.declareIdentityCard(mic);
            }
        }

        const declareIds = await Promise.all(promises);
        for (const id of declareIds) {
            this.declare(id);
        }
    }

    /**
     * @private
     * @method declareEntity
     * @memberof Metric#
     * @param {Entity} entity entity
     * @return {Promise&lt;Number>}
     */
    async declareEntity(entity) {
        const data = entity.toJSON();
        const oldId = entity.id;
        const newId = await this.sendMessage("events.declare_entity", data)

        entity.id = newId;
        entity.dbPushed = true;

        // Reset all Ids after pushed in DB
        if (this.linker.has(oldId)) {
            const elems = this.linker.get(oldId);
            this.linker.delete(oldId);
            this.linker.set(newId, elems);

            for (const elem of elems) {
                if (typeof elem === "number") {
                    this.entities[elem].parent = newId;
                }
                else {
                    const mic = this.mic.get(elem);
                    mic.entityId = newId;
                }
            }
        }

        return newId;
    }

    /**
     * @private
     * @method declareIdentityCard
     * @memberof Metric#
     * @param  {MetricIdentityCard} mic mic
     * @return {Promise&lt;void>};
     */
    async declareIdentityCard(mic) {
        const data = mic.toJSON();
        const newId = await this.sendMessage("events.declare_mic", data);
        mic.id = newId;
        mic.dbPushed = true;
    }


    /**
     * @method identityCard
     * @param {String} name Entity name
     * @param {Object} options Entity options
     * @return {MetricIdentityCard}
     */
    identityCard(name, options) {
        const identityCard = new MetricIdentityCard(name, options);
        this.mic.set(identityCard.name, identityCard);
        this.setLinker(identityCard.entityId, identityCard.name);
        // if (this.eventLoaded === true) {
        //     if (Reflect.has(options, "entity") &amp;&amp; options.entity.dbPushed === true) {
        //         this.declareIdentityCard();
        //     }
        // }

        return identityCard;
    }

    /**
     * @method entity
     * @param {String} name Entity name
     * @param {Object} options Entity options
     * @return {Entity}
     */
    entity(name, options) {
        const ent = new Entity(name, options);
        const index = this.entities.push(ent);

        this.setLinker(ent.parent, index - 1);

        if (this.eventLoaded === true) {
            if (Reflect.has(options, "parent") &amp;&amp; options.parent.dbPushed === true) {
                this.declareEntity(ent.parent);
            }
        }

        return ent;
    }

    /**
     * @private
     * @method setLinker
     * @memberof Metric#
     * @param {Number} parent parent
     * @param {Number|String} value value
     *
     * @returns {void}
     */
    setLinker(parent, value) {
        if (!this.linker.has(parent)) {
            this.linker.set(parent, [value]);
        }
        else {
            this.linker.get(parent).push(value);
        }
    }

}

module.exports = Metric;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Oct 30 2018 19:44:21 GMT+0100 (GMT+01:00) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
